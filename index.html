<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Circuit Metrics Plots Generator</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 24px;
            background: #f8fafc;
            color: #334155;
        }
        
        .header {
            background: white;
            padding: 24px;
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            margin-bottom: 24px;
        }
        
        .header h1 {
            margin: 0 0 8px 0;
            color: #1e293b;
            font-size: 24px;
            font-weight: 600;
        }
        
        .header p {
            margin: 0;
            color: #64748b;
            font-size: 14px;
        }
        
        .experiments-section {
            background: white;
            padding: 24px;
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            margin-bottom: 24px;
        }
        
        .section-title {
            margin: 0 0 16px 0;
            color: #1e293b;
            font-size: 18px;
            font-weight: 600;
        }
        
        .experiment-item {
            display: flex;
            flex-direction: column;
            padding: 8px 12px;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            margin-bottom: 8px;
            transition: all 0.2s ease;
        }
        
        .experiment-item:hover {
            border-color: #cbd5e1;
            background: #f8fafc;
        }
        
        .experiment-item.selected {
            border-color: #3b82f6;
            background: #eff6ff;
        }
        
        .experiment-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
        }
        
        .experiment-checkbox {
            margin: 0;
        }
        
        .experiment-name {
            font-weight: 500;
            color: #1e293b;
            font-size: 14px;
        }
        
        .slider-container {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }
        
        .dual-range-slider {
            position: relative;
            height: 30px;
            width: 100%;
        }
        
        .dual-range-slider input[type="range"] {
            position: absolute;
            width: 100%;
            background: transparent;
            -webkit-appearance: none;
            pointer-events: none;
        }
        
        .dual-range-slider input[type="range"]::-webkit-slider-thumb {
            appearance: none;
            height: 20px;
            width: 20px;
            border-radius: 50%;
            border: 2px solid white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            cursor: pointer;
            pointer-events: all;
            margin-top: -0px;
        }
        
        .dual-range-slider .range-min::-webkit-slider-thumb {
            background: #f63b79;
        }
        
        .dual-range-slider .range-max::-webkit-slider-thumb {
            background: #f63b79;
        }
        
        .slider-track {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            height: 6px;
            background: #e2e8f0;
            border-radius: 3px;
            width: 100%;
        }
        
        .slider-range {
            position: absolute;
            height: 6px;
            background: #f63b79;
            border-radius: 3px;
            top: 50%;
            transform: translateY(-50%);
        }
        
        .range-labels {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            color: #64748b;
        }
        
        .range-display {
            font-size: 12px;
            color: #374151;
            font-weight: 500;
            text-align: center;
            padding: 4px 8px;
            background: #f1f5f9;
            border-radius: 4px;
            margin-top: 4px;
        }
        
        .controls-section {
            background: white;
            padding: 24px;
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            margin-bottom: 24px;
        }
        
        .control-row {
            display: flex;
            align-items: center;
            gap: 16px;
            margin-bottom: 20px;
        }
        
        .control-label {
            font-weight: 500;
            color: #1e293b;
            min-width: 60px;
        }
        
        .metric-select {
            flex: 1;
            padding: 8px 12px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            background: white;
            font-size: 14px;
            color: #374151;
        }
        
        .generate-btn {
            background: #f63b79;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }
        
        .generate-btn:hover {
            background: #ff1865;
        }
        
        .generate-btn:disabled {
            background: #9ca3af;
            cursor: not-allowed;
        }
        
        .loading {
            color: #64748b;
            font-style: italic;
        }
        
        .empty-state {
            text-align: center;
            color: #64748b;
            padding: 40px 20px;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>Circuit Metrics Plots Generator</h1>
        <p>Select experiments and configure parameters to generate circuit plots visualizing key metrics. Make sure to select very small bit widths for larger circuits as simulation time and computation of metrics might take a while!</p>
    </div>
    
    <div class="experiments-section">
        <h2 class="section-title">Select Experiments</h2>
        <div id="experiments-list" class="loading">Loading experiments...</div>
    </div>
    
    <div class="controls-section">
        <h2 class="section-title">Configuration</h2>
        <div class="control-row">
            <label class="control-label" for="metric-select">Metric:</label>
            <select id="metric-select" class="metric-select">
                <option>Loading...</option>
            </select>
        </div>
        <button id="generate-btn" class="generate-btn">Generate Plot</button>
    </div>

    <script>
        const POW2 = [2, 4, 8, 16, 32, 64, 128, 256, 512, 1024, 2048, 4096];
        
        function createDualRangeSlider(initialMin = 1, initialMax = 8) {
            const container = document.createElement("div");
            container.className = "slider-container";
            
            const sliderContainer = document.createElement("div");
            sliderContainer.className = "dual-range-slider";
            
            const track = document.createElement("div");
            track.className = "slider-track";
            
            const range = document.createElement("div");
            range.className = "slider-range";
            
            const minSlider = document.createElement("input");
            minSlider.type = "range";
            minSlider.min = 0;
            minSlider.max = POW2.length - 1;
            minSlider.value = initialMin;
            minSlider.className = "range-min";
            
            const maxSlider = document.createElement("input");
            maxSlider.type = "range";
            maxSlider.min = 0;
            maxSlider.max = POW2.length - 1;
            maxSlider.value = initialMax;
            maxSlider.className = "range-max";
            
            sliderContainer.appendChild(track);
            sliderContainer.appendChild(range);
            sliderContainer.appendChild(minSlider);
            sliderContainer.appendChild(maxSlider);
            
            const labels = document.createElement("div");
            labels.className = "range-labels";
            const minLabel = document.createElement("span");
            const maxLabel = document.createElement("span");
            labels.appendChild(minLabel);
            labels.appendChild(maxLabel);
            
            const rangeDisplay = document.createElement("div");
            rangeDisplay.className = "range-display";
            
            function updateSlider() {
                let minVal = parseInt(minSlider.value);
                let maxVal = parseInt(maxSlider.value);
                
                if (minVal > maxVal) {
                    if (document.activeElement === minSlider) {
                        maxVal = minVal;
                        maxSlider.value = minVal;
                    } else {
                        minVal = maxVal;
                        minSlider.value = maxVal;
                    }
                }
                
                minLabel.textContent = `${POW2[minVal]} bits`;
                maxLabel.textContent = `${POW2[maxVal]} bits`;
                
                const minPercent = (minVal / (POW2.length - 1)) * 100;
                const maxPercent = (maxVal / (POW2.length - 1)) * 100;
                
                range.style.left = `${minPercent}%`;
                range.style.width = `${maxPercent - minPercent}%`;
                
                const bitWidths = POW2.slice(minVal, maxVal + 1);
                if (bitWidths.length === 1) {
                    rangeDisplay.textContent = `Bit width: ${bitWidths[0]}`;
                } else {
                    rangeDisplay.textContent = `Bit widths: ${bitWidths.join(', ')}`;
                }
            }
            
            minSlider.addEventListener("input", updateSlider);
            maxSlider.addEventListener("input", updateSlider);
            updateSlider();
            
            container.appendChild(sliderContainer);
            container.appendChild(labels);
            container.appendChild(rangeDisplay);
            
            return {
                element: container,
                getBitWidths: () => {
                    const minVal = parseInt(minSlider.value);
                    const maxVal = parseInt(maxSlider.value);
                    const actualMin = Math.min(minVal, maxVal);
                    const actualMax = Math.max(minVal, maxVal);
                    return POW2.slice(actualMin, actualMax + 1);
                }
            };
        }
        
        async function loadExperiments() {
            try {
                const response = await fetch("/funcs");
                const functions = await response.json();
                const container = document.getElementById("experiments-list");
                
                container.innerHTML = "";
                
                if (functions.length === 0) {
                    container.innerHTML = '<div class="empty-state">No experiments available</div>';
                    return;
                }
                
                functions.forEach(fn => {
                    const item = document.createElement("div");
                    item.className = "experiment-item";
                    
                    const header = document.createElement("div");
                    header.className = "experiment-header";
                    
                    const checkbox = document.createElement("input");
                    checkbox.type = "checkbox";
                    checkbox.className = "experiment-checkbox";
                    checkbox.dataset.fn = fn;
                    
                    const name = document.createElement("span");
                    name.className = "experiment-name";
                    name.textContent = fn;
                    
                    header.appendChild(checkbox);
                    header.appendChild(name);
                    
                    const rangeSlider = createDualRangeSlider();
                    
                    checkbox.addEventListener("change", () => {
                        item.classList.toggle("selected", checkbox.checked);
                    });
                    
                    item.appendChild(header);
                    item.appendChild(rangeSlider.element);
                    
                    item.rangeSlider = rangeSlider;
                    
                    container.appendChild(item);
                });
            } catch (error) {
                document.getElementById("experiments-list").innerHTML = 
                    '<div class="empty-state">Error loading experiments</div>';
                console.error("Failed to load experiments:", error);
            }
        }
        
        async function loadMetrics() {
            try {
                const response = await fetch("/metrics");
                const metrics = await response.json();
                const select = document.getElementById("metric-select");
                
                select.innerHTML = "";
                
                metrics.forEach(metric => {
                    const option = document.createElement("option");
                    option.value = metric;
                    option.textContent = metric;
                    select.appendChild(option);
                });
            } catch (error) {
                document.getElementById("metric-select").innerHTML = 
                    '<option>Error loading metrics</option>';
                console.error("Failed to load metrics:", error);
            }
        }
        
        async function generatePlot() {
            const selectedExperiments = [...document.querySelectorAll(".experiment-item")]
                .filter(item => item.querySelector("input").checked)
                .map(item => ({
                    name: item.querySelector("input").dataset.fn,
                    fn: item.querySelector("input").dataset.fn,
                    bits: item.rangeSlider.getBitWidths()
                }));
            
            if (selectedExperiments.length === 0) {
                alert("Please select at least one experiment");
                return;
            }
            
            const payload = {
                experiments: selectedExperiments,
                metric: document.getElementById("metric-select").value
            };
            
            const button = document.getElementById("generate-btn");
            button.disabled = true;
            button.textContent = "Generating...";
            
            try {
                const response = await fetch("/plot.png", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(payload)
                });
                
                if (!response.ok) {
                    const errorText = await response.text();
                    alert(`Error: ${errorText}`);
                    return;
                }
                
                const blob = await response.blob();
                const url = URL.createObjectURL(blob);
                window.open(url, "_blank");
            } catch (error) {
                alert("Failed to generate plot. Please try again.");
                console.error("Plot generation error:", error);
            } finally {
                button.disabled = false;
                button.textContent = "Generate Plot";
            }
        }
        
        document.getElementById("generate-btn").addEventListener("click", generatePlot);
        
        loadExperiments();
        loadMetrics();
    </script>
</body>
</html>